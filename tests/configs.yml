---

- name: Install
  hosts: all
  pre_tasks:
    - include: pre_tasks/manala.yml
  vars:
    manala_backup_manager_configs:
      - file:     mysql.conf
        template: configs/mysql.j2
        config:
          - BM_REPOSITORY_ROOT: /srv/backup/mysql
  roles:
    - manala.backup-manager
  post_tasks:
    # Goss
    - name: Goss
      raw: "{{ 'echo \"' ~ item|to_yaml ~ '\"|goss -g - validate' }}"
      with_items:
        - file:
            /etc/backup-manager.d:
              exists:   true
              filetype: directory
              owner:    root
              group:    root
              mode:     "0700"
            /etc/backup-manager.d/mysql.conf:
              exists:   true
              filetype: file
              owner:    root
              group:    root
              mode:     "0600"
              contains:
                - export BM_REPOSITORY_ROOT=
                - /srv/backup/mysql
